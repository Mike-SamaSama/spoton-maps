name: 'Auto-generate and Open PR'

permissions:
  contents: write
  pull-requests: write

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 * * * *' # hourly
  workflow_dispatch: {}

defaults:
  run:
    # use a login bash shell so PATH and profile are available for install/build steps
    shell: bash -l {0}

jobs:
  autogen:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Debug: repo state
        run: |
          echo "== Git status =="
          git status --porcelain || true
          echo "== Current branch =="
          git rev-parse --abbrev-ref HEAD || true
          echo "== Git log (last 5) =="
          git --no-pager log --oneline -5 || true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Debug: system & tool versions
        run: |
          echo "== Node & NPM versions =="
          node -v || true
          npm -v || true
          echo "== Yarn version (if present) =="
          yarn -v || true

      - name: Debug: repo listing before generation
        run: |
          echo "== Working directory =="
          pwd
          echo "== Repo root listing (top 200 lines) =="
          ls -la | sed -n '1,200p' || true
          echo "== Disk usage (top-level) =="
          du -sh . || true
          echo "== Git config & remotes =="
          git --no-pager config --list || true
          git remote -v || true

      - name: Run generation tasks
        run: |
          echo "Running docs generator"
          npm run generate-docs

      - name: Debug: git status after generation
        run: |
          echo "== Git status (porcelain) =="
          git status --porcelain || true
          echo "== Git diff (name-only) =="
          git diff --name-only || true

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "chore(autogen): generated content by GitHub Actions"
          else
            echo "No changes to commit"
            exit 0
          fi

      - name: Debug: show last commit and changed files
        if: always()
        run: |
          echo "== Last commit =="
          git --no-pager log -1 || true
          echo "== Changed files in last commit =="
          git --no-pager show --name-only --pretty="" HEAD || true

      - name: Create or update Pull Request (autogen)
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(autogen): generated content by GitHub Actions"
          branch: autogen
          title: "chore: autogen updates"
          body: "This PR was created by the auto-generation workflow. Review and merge if appropriate."
          base: main
